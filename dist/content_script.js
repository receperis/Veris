(()=>{"use strict";const e={bubbleEl:null,lastSelection:"",settings:null,extensionEnabled:!0,selectedWords:new Map,selectionContextElement:null,tempTargetLang:null,bubbleLangMenuEl:null,combinationMode:!1,selectedWordsForCombination:new Set,triggerIconEl:null,triggerIconTimer:null,pendingSelection:null,lastCopyKeyTime:0,hotkeySpec:null,sequenceProgress:0,lastSequenceTime:0,skipNextSelection:!1},t={target_lang:"en",bubbleMode:"auto",bubbleIconDelay:450,bubbleHotkey:""};function n(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}function a(e){return{auto:"Auto",en:"EN",es:"ES",fr:"FR",de:"DE",it:"IT",pt:"PT",ru:"RU",ja:"JA",ko:"KO",zh:"ZH","zh-cn":"CN","zh-tw":"TW",ar:"AR",hi:"HI",tr:"TR",nl:"NL",sv:"SV",da:"DA",no:"NO",fi:"FI",pl:"PL",cs:"CS",sk:"SK",hu:"HU",ro:"RO",bg:"BG",hr:"HR",sr:"SR",sl:"SL",et:"ET",lv:"LV",lt:"LT",uk:"UK",be:"BE",mk:"MK",mt:"MT",ca:"CA",eu:"EU",gl:"GL",is:"IS",sq:"SQ",el:"EL",he:"HE",fa:"FA",th:"TH",vi:"VI",id:"ID",ms:"MS",ur:"UR",bn:"BN",ta:"TA",te:"TE",ml:"ML",kn:"KN",gu:"GU",pa:"PA",ne:"NE",si:"SI",my:"MY",km:"KM",lo:"LO",ka:"KA",am:"AM",sw:"SW",af:"AF"}[e]||e.toUpperCase().slice(0,3)}function o(e){return{auto:"Auto Detected",en:"English",es:"Spanish",fr:"French",de:"German",it:"Italian",pt:"Portuguese",ru:"Russian",ja:"Japanese",ko:"Korean",zh:"Chinese","zh-cn":"Chinese (Simplified)","zh-tw":"Chinese (Traditional)",ar:"Arabic",hi:"Hindi",tr:"Turkish",nl:"Dutch",sv:"Swedish",da:"Danish",no:"Norwegian",fi:"Finnish",pl:"Polish",cs:"Czech",sk:"Slovak",hu:"Hungarian",ro:"Romanian",bg:"Bulgarian",hr:"Croatian",uk:"Ukrainian",el:"Greek",he:"Hebrew",fa:"Persian",th:"Thai",vi:"Vietnamese",id:"Indonesian",ms:"Malay",ur:"Urdu",bn:"Bengali",ta:"Tamil",te:"Telugu",ml:"Malayalam",kn:"Kannada",gu:"Gujarati",pa:"Punjabi",ne:"Nepali",si:"Sinhala",my:"Burmese",km:"Khmer",lo:"Lao",ka:"Georgian",am:"Amharic",sw:"Swahili",af:"Afrikaans"}[e]||e.toUpperCase()}function s(e){if(!e)return null;const t=e.split("+").map(e=>e.trim()).filter(Boolean),n={ctrl:!1,shift:!1,alt:!1,meta:!1,keys:[]};return t.forEach(e=>{const t=e.toLowerCase();["ctrl","control"].includes(t)?n.ctrl=!0:"shift"===t?n.shift=!0:["alt","option"].includes(t)?n.alt=!0:["meta","cmd","command"].includes(t)?n.meta=!0:n.keys.push(e.toLowerCase())}),0===n.keys.length?null:n}function l(t,n){const{selectionContextElement:a,lastSelection:o}=e;if(!a)return o;let s="";try{s=a.innerText||a.textContent||""}catch{}if(!s)return o;if(s=s.replace(/\s+/g," ").trim(),!s)return o;const l=s.split(/(?<=[.!?])\s+/),r=(t||"").toLowerCase(),i=(n||"").toLowerCase();let c=l.find(e=>e.toLowerCase().includes(r));return!c&&i&&(c=l.find(e=>e.toLowerCase().includes(i))),(c||o).trim()}function r(){e.triggerIconTimer&&(clearTimeout(e.triggerIconTimer),e.triggerIconTimer=null),e.triggerIconEl&&(e.triggerIconEl.remove(),e.triggerIconEl=null)}function i(){e.bubbleEl&&(e.bubbleEl.remove(),e.bubbleEl=null,e.selectedWords.clear(),e.combinationMode=!1,e.selectedWordsForCombination.clear())}function c(t){e.bubbleLangMenuEl&&!e.bubbleLangMenuEl.contains(t.target)&&d()}function d(){e.bubbleLangMenuEl&&(e.bubbleLangMenuEl.remove(),e.bubbleLangMenuEl=null)}if(!document.getElementById("__translator_lang_menu_style")){const e=document.createElement("style");e.id="__translator_lang_menu_style",e.textContent="\n  .__translator_lang_menu{background:#fff;border:1px solid #d1d5db;border-radius:8px;padding:8px 0;width:220px;box-shadow:0 8px 24px rgba(0,0,0,.15);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:12px;}\n  .__translator_lang_menu .__lang_menu_header{padding:0 10px 6px;}\n  .__translator_lang_menu .__lang_menu_search{width:100%;padding:6px 8px;border:1px solid #e5e7eb;border-radius:6px;font-size:12px;}\n  .__translator_lang_menu .__lang_menu_list{max-height:260px;overflow-y:auto;}\n  .__translator_lang_menu .__lang_menu_item{padding:6px 10px;display:flex;gap:6px;cursor:pointer;align-items:center;}\n  .__translator_lang_menu .__lang_menu_item .code{font-weight:600;color:#374151;min-width:32px;}\n  .__translator_lang_menu .__lang_menu_item .name{color:#6b7280;flex:1;}\n  .__translator_lang_menu .__lang_menu_item:hover{background:#f3f4f6;}\n  .__translator_lang_menu .__lang_menu_item.active{background:#eef2ff;}\n  ",document.head.appendChild(e)}function u(e){try{let t=document.getElementById("__translator_toast_container");t||(t=document.createElement("div"),t.id="__translator_toast_container",t.style.position="fixed",t.style.top="12px",t.style.right="14px",t.style.display="flex",t.style.flexDirection="column",t.style.gap="8px",t.style.zIndex=2147483647,document.body.appendChild(t));const n=document.createElement("div");n.className="__translator_toast",n.textContent="ðŸ’¾ "+e,n.style.background="#16a34a",n.style.color="#fff",n.style.padding="8px 14px",n.style.fontSize="13px",n.style.lineHeight="1.3",n.style.borderRadius="6px",n.style.boxShadow="0 4px 14px rgba(0,0,0,0.25)",n.style.fontFamily="system-ui,-apple-system,Segoe UI,Roboto,sans-serif",n.style.opacity="0",n.style.transform="translateY(-6px)",n.style.transition="opacity .25s ease, transform .25s ease",t.appendChild(n),requestAnimationFrame(()=>{n.style.opacity="1",n.style.transform="translateY(0)"}),setTimeout(()=>{n.style.opacity="0",n.style.transform="translateY(-6px)",setTimeout(()=>{n.remove(),t.childElementCount||t.remove()},300)},2600)}catch(e){console.warn("Failed to show save toast:",e)}}async function g(e,t,n){try{const a=e.trim();if(!a)throw new Error("Empty text provided for translation");if("Translator"in self){const e=await Translator.create({sourceLanguage:n,targetLanguage:t});return await e.translate(a)}throw new Error("Built-in Translation API not available")}catch(e){throw console.error("Translation error:",e),e}}function b(t,a,o=!1){const s=e.bubbleEl.querySelector(".word-translation");if(!s)return;s.classList.add("show");let l=s.querySelector(`[data-word="${n(t)}"]`);if(l||(l=document.createElement("div"),l.className="word-translation-item",l.dataset.word=t,s.appendChild(l)),o)l.innerHTML=`\n      <div class="word-translation-content loading">\n        <span class="word-original">${n(t)}</span>\n        <span class="word-translated">Translating...</span>\n      </div>\n    `;else{l.innerHTML=`\n      <div class="word-translation-content">\n        <span class="word-original">${n(t)}</span>\n        <span class="word-translated">${n(a)}</span>\n        <button class="add-word-btn" data-word="${n(t)}" data-translation="${n(a)}">\n          + Add\n        </button>\n      </div>\n    `;const o=l.querySelector(".add-word-btn");o.addEventListener("click",n=>{n.stopPropagation();const s=e.bubbleEl.querySelector(`.word-pill[data-word="${t}"]`);!function(t,n){if(n){if(event?.stopPropagation(),n.classList.contains("selected"))n.classList.remove("selected"),e.selectedWords.delete(t);else{let a="Translation needed";const o=e.bubbleEl?.querySelector(".word-translation");if(o){const e=o.querySelector(`[data-word="${t}"]`);if(e){const t=e.querySelector(".word-translated");t&&(a=t.textContent)}}"Translation needed"===a&&n.classList.contains("active")&&(a="Please click the word first to translate"),n.classList.add("selected"),e.selectedWords.set(t,a)}m()}}(t,s);const r=l.querySelector(".word-translated"),i=r?r.textContent:o.getAttribute("data-translation")||a;e.selectedWords.set(t,i)});const s=l.querySelector(".word-translated");s&&p(s,o,t)}}function m(){if(!e.bubbleEl)return;const t=e.bubbleEl.querySelector(".save-section"),n=e.bubbleEl.querySelector(".save-count"),a=e.selectedWords.size;a>0?(t.classList.add("show"),n.textContent=a):t.classList.remove("show")}function p(t,n,a){t.style.cursor="text",t.title="Click to edit translation",t.addEventListener("click",o=>{if(o.stopPropagation(),"1"===t.dataset.editing)return;t.dataset.editing="1";const s=t.textContent||"",l=document.createElement("input");l.type="text",l.className="translation-edit-input",l.value=s,l.style.fontSize="12px",l.style.padding="2px 4px",l.style.marginLeft="4px",l.style.minWidth="110px",l.style.border="1px solid #9ca3af",l.style.borderRadius="4px",l.style.outline="none",l.style.background="#fff",l.style.color="#111",t.replaceWith(l),l.focus(),l.select();let r=!1;const i=()=>{if(r)return;r=!0;const t=(l.value||"").trim()||s,o=document.createElement("span");o.className="word-translated",o.textContent=t,l.replaceWith(o),n.setAttribute("data-translation",t),e.selectedWords.has(a)&&(e.selectedWords.set(a,t),m()),p(o,n,a)};l.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(e.preventDefault(),(()=>{if(r)return;r=!0;const e=document.createElement("span");e.className="word-translated",e.textContent=s,l.replaceWith(e),p(e,n,a)})())}),l.addEventListener("blur",i,{once:!0})},{once:!0})}function y(){if(!e.bubbleEl)return;const t=e.bubbleEl.querySelector(".word-translation");if(!t)return;const n=t.querySelector(".instant-combination-translation");n&&n.remove(),0===t.querySelectorAll(".word-translation-item").length&&t.classList.remove("show")}async function f(r,p){!function(t,a,o,s=!1,l=null){i();const r=document.createElement("div");r.className="__translator_bubble"+(s?" __translator_loading":""),r.id="translate_bubble";const c=l&&!s?`\n    <div class="language-indicator">\n      <div class="language-badge source-lang">\n        <span class="lang-label">${n(l.sourceLang)}</span>\n      </div>\n      <div class="language-arrow">â†’</div>\n      <div class="language-badge target-lang">\n        <span class="lang-label">${n(l.targetLang)}</span>\n      </div>\n    </div>\n  `:"";r.innerHTML=`\n    <div class="close-btn" title="Close">Ã—</div>\n    ${c}\n    <div class="source-text">${n(a)}</div>\n    <div class="translated-text">${n(o)}</div>\n    <div class="word-breakdown">\n\n      <div class="combination-controls">\n        <div class="combination-status show">\n           <div class="combination-info">\n              <span>Click words for individual translations</span>\n          </div>\n        </div>\n        <button class="combination-btn" title="Enter combination mode for multiple words">ðŸ”—</button>\n      </div>\n      <div class="word-pills"></div>\n      <div class="word-translation"></div>\n    </div>\n    <div class="save-section">\n      <button class="save-button-translate">\n        <span>ðŸ’¾</span>\n        <span>Save</span>\n        <span class="save-count">0</span>\n      </button>\n      <div class="save-status"></div>\n    </div>\n    <div class="meta">Built-in Translation</div>\n  `;const d=window.pageXOffset||document.documentElement.scrollLeft,u=window.pageYOffset||document.documentElement.scrollTop,g=t.left+d,b=t.bottom+u+5;r.style.left=g+"px",r.style.top=b+"px",document.body.appendChild(r),e.bubbleEl=r,r.querySelector(".close-btn").addEventListener("click",e=>{e.stopPropagation(),i()}),r.querySelector(".save-button-translate").addEventListener("click",e=>{e.stopPropagation()}),r.querySelector(".combination-btn").addEventListener("click",e=>{e.stopPropagation()})}(p,r,"Translating...",!0),e.settings=await chrome.storage.sync.get(t),e.hotkeySpec=s(e.settings.bubbleHotkey);let f,v="auto";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(v=e.sourceLanguage)}catch(e){console.warn("Could not get source language:",e)}try{f=await g(r,e.settings.target_lang,v)}catch(t){console.error("Translation failed, attempting detection fallback:",t);try{const t=await chrome.runtime.sendMessage({type:"DETECT_PAGE_LANGUAGE"});if(t&&t.ok){if(f=`Source language: ${t.language}. Translation API not available.`,e.bubbleEl){const n={sourceLang:a(t.language||"auto"),targetLang:a(e.settings.target_lang)},o=document.createElement("div");o.className="language-indicator fallback",o.innerHTML=`<div class="language-badge source-lang"><span class="lang-label">${n.sourceLang}</span></div><div class="language-arrow">âš </div><div class="language-badge target-lang"><span class="lang-label">${n.targetLang}</span></div>`;const s=e.bubbleEl.querySelector(".close-btn");s&&s.nextSibling&&e.bubbleEl.insertBefore(o,s.nextSibling)}}else f="Translation and language detection failed: "+(t&&t.error?t.error:"Unknown error")}catch(e){f="Translation not available: "+t.message}}if(e.bubbleEl){e.bubbleEl.classList.remove("__translator_loading"),e.bubbleEl.setAttribute("data-selection",r);const t=e.bubbleEl.querySelector(".translated-text");if(t&&(t.textContent=f),!e.bubbleEl.querySelector(".language-indicator:not(.fallback)")){const t={sourceLang:a(v),targetLang:a(e.settings.target_lang)},s=document.createElement("div");s.className="language-indicator",s.innerHTML=`<div class="language-badge source-lang"><span class="lang-label">${n(t.sourceLang)}</span></div><div class="language-arrow">â†’</div><div class="language-badge target-lang"><span class="lang-label">${n(t.targetLang)}</span></div>`;const l=e.bubbleEl.querySelector(".close-btn");l&&l.nextSibling&&e.bubbleEl.insertBefore(s,l.nextSibling);const r=s.querySelector(".language-badge.target-lang");r?.addEventListener("click",t=>{t.stopPropagation(),function(t,n){d();const s=document.createElement("div");s.className="__translator_lang_menu",s.id="lang_menu";const l=e.tempTargetLang||e.settings?.target_lang||"en";s.innerHTML=`\n    <div class="__lang_menu_header">\n      <input type="text" placeholder="Search language..." class="__lang_menu_search" />\n    </div>\n    <div class="__lang_menu_list">\n      ${["en","es","fr","de","it","pt","ru","ja","ko","zh","ar","hi","tr","nl","sv","da","no","fi","pl","cs","sk","hu","ro","bg","hr","uk","el","he","fa","th","vi","id","ms","sw"].map(e=>`<div class="__lang_menu_item ${e===l?"active":""}" data-code="${e}">\n         <span class="code">${a(e)}</span>\n         <span class="name">${o(e)}</span>\n      </div>`).join("")}\n    </div>`,document.body.appendChild(s),e.bubbleLangMenuEl=s;const r=t.getBoundingClientRect();s.style.position="absolute",s.style.top=window.scrollY+r.bottom+6+"px",s.style.left=window.scrollX+r.left+"px",s.style.zIndex=9999,s.addEventListener("click",async e=>{const t=e.target.closest(".__lang_menu_item");if(!t)return;const a=t.dataset.code;"function"==typeof n&&await n(a),d()});const i=s.querySelector(".__lang_menu_search");i.addEventListener("input",()=>{const e=i.value.trim().toLowerCase();s.querySelectorAll(".__lang_menu_item").forEach(t=>{const n=t.dataset.code,s=o(n).toLowerCase(),l=a(n).toLowerCase();t.style.display=!e||s.includes(e)||l.includes(e)?"":"none"})}),setTimeout(()=>{document.addEventListener("mousedown",c,{capture:!0,once:!0})},0)}(r,w)})}!function(t){if(!e.bubbleEl)return;const a=e.bubbleEl.querySelector(".word-pills");a&&(t.match(/[\p{L}\p{N}]+/gu)||[]).forEach((t,o)=>{const s=document.createElement("span");s.className="word-pill",s.textContent=t,s.dataset.word=t,s.dataset.index=o,s.addEventListener("click",a=>{a.stopPropagation(),async function(t,a){if(e.bubbleEl)if(e.combinationMode)!function(t,a){if(!e.combinationMode||!e.bubbleEl)return;const o=e.selectedWordsForCombination.has(t),s=e.bubbleEl.querySelector(".combination-status");o?(e.selectedWordsForCombination.delete(t),a.classList.remove("combination-selected")):(e.selectedWordsForCombination.add(t),a.classList.add("combination-selected"));const l=s?.querySelector(".combination-info span");l&&(e.selectedWordsForCombination.size>=2?(l.textContent=`${e.selectedWordsForCombination.size} words selected for combination`,async function(){if(!e.bubbleEl||e.selectedWordsForCombination.size<2)return;const t=Array.from(e.bubbleEl.querySelectorAll(".word-pill")).filter(t=>e.selectedWordsForCombination.has(t.dataset.word));if(0===t.length)return;const a=t.map(e=>e.dataset.word).join(" "),o=e.bubbleEl.querySelector(".word-translation");if(!o)return;o.classList.add("show");let s=o.querySelector(".instant-combination-translation");s||(s=document.createElement("div"),s.className="word-translation-item instant-combination-translation",s.dataset.combinationPhrase=a,o.insertBefore(s,o.firstChild)),s.innerHTML=`\n    <div class="word-translation-content combination-instant loading">\n      <span class="combination-label">ðŸ”— Combined:</span>\n      <span class="word-original">"${n(a)}"</span>\n      <span class="word-translated">Translating...</span>\n    </div>\n  `;try{const t=await chrome.storage.sync.get({target_lang:"en"});let o="auto";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(o=e.sourceLanguage)}catch(e){console.warn("Could not get source language for instant combination translation:",e)}const l=await g(a,t.target_lang,o);s.innerHTML=`\n      <div class="word-translation-content combination-instant">\n        <span class="combination-label">ðŸ”— Combined:</span>\n        <span class="word-original">"${n(a)}"</span>\n        <span class="word-translated">${n(l)}</span>\n        <button class="add-word-btn combination-add" data-phrase="${n(a)}" data-translation="${n(l)}">\n          Save Combination\n        </button>\n      </div>\n    `,s.addEventListener("click",e=>{e.stopPropagation()});const r=s.querySelector(".combination-add");r?.addEventListener("click",t=>{t.stopPropagation(),async function(t,n){if(!e.bubbleEl)return void console.warn("Cannot save combination: bubble element is null");const a=e.bubbleEl.querySelector(".save-combination-btn");a&&(a.innerHTML="ðŸ’¾ Saving...",a.disabled=!0);try{let o="";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(o=e.sourceLanguage)}catch(e){console.warn("Could not get detected source language:",e)}const s={timestamp:(new Date).toISOString(),originalWord:t,translatedWord:n,context:e.lastSelection,targetLanguage:e.settings?.target_lang||"en",sourceLanguage:o,url:window.location.href,domain:window.location.hostname,isCombination:!0,combinedWords:Array.from(e.selectedWordsForCombination)},l=await chrome.runtime.sendMessage({type:"SAVE_VOCABULARY",data:s});if(!l||!l.success)throw new Error(l?l.error:"No response from save service");a&&(a.innerHTML="âœ… Saved!",setTimeout(()=>{a&&(a.innerHTML="ðŸ’¾ Save Combination",a.disabled=!1)},2e3)),u(`Combination "${t}" saved!`)}catch(e){console.error("Failed to save combination:",e),a&&(a.innerHTML="âŒ Save Failed",setTimeout(()=>{a&&(a.innerHTML="ðŸ’¾ Save Combination",a.disabled=!1)},2e3))}}(a,l)})}catch(e){console.error("Instant combination translation failed:",e),s.innerHTML=`\n      <div class="word-translation-content combination-instant error">\n        <span class="combination-label">ðŸ”— Combined:</span>\n        <span class="word-original">"${n(a)}"</span>\n        <span class="word-translated error">Translation failed</span>\n      </div>\n    `}}()):(l.textContent="Select words to combine for multiple words",y()))}(t,a);else{if(a.classList.contains("active"))return a.classList.remove("active"),a.classList.remove("selected"),function(t){const a=e.bubbleEl.querySelector(".word-translation");if(!a)return;const o=a.querySelector(`[data-word="${n(t)}"]`);o&&o.remove(),0===a.querySelectorAll(".word-translation-item").length&&a.classList.remove("show")}(t),e.selectedWords.delete(t),void m();if(a.classList.add("active"),e.bubbleEl.querySelector(".word-translation")){b(t,"Translating word...",!0);try{const e=t.replace(/[.,;:!?"""''()[\]{}]/g,"").trim();if(!e)return void b(t,"Punctuation",!1);const n=await chrome.storage.sync.get({target_lang:"en"});let a,o="auto";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(o=e.sourceLanguage)}catch(e){console.warn("Could not get source language for word translation:",e)}try{a=await g(e,n.target_lang,o)}catch(e){console.error("Word translation failed:",e),a="Translation unavailable"}b(t,a,!1)}catch(e){console.error("Error in word translation:",e),b(t,"Error",!1)}}}}(t,s)}),a.appendChild(s)})}(r);const s=e.bubbleEl.querySelector(".save-button-translate");s?.addEventListener("click",t=>{t.stopPropagation(),async function(){if(0===e.selectedWords.size)return;const t=e.bubbleEl?.querySelector(".save-status");t&&(t.textContent=`ðŸ’¾ Saving ${e.selectedWords.size} words...`,t.classList.add("show"));try{let n="";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(n=e.sourceLanguage)}catch(e){console.warn("Could not get detected source language:",e)}const a={timestamp:(new Date).toISOString(),originalText:e.lastSelection,targetLanguage:e.settings?.target_lang||"en",sourceLanguage:n,words:Array.from(e.selectedWords.entries()).map(([e,t])=>({original:e,translation:t,context:l(e,t)})),totalWords:e.selectedWords.size,url:window.location.href,domain:window.location.hostname},o=[];for(const[t,s]of e.selectedWords.entries()){const r={timestamp:(new Date).toISOString(),originalWord:t,translatedWord:s,context:l(t,s),targetLanguage:e.settings?.target_lang||"en",sourceLanguage:n,url:window.location.href,domain:window.location.hostname,sessionId:a.timestamp};try{const e=await chrome.runtime.sendMessage({type:"SAVE_VOCABULARY",data:r});e&&e.success?o.push(e.id):console.error("Failed to save word via service worker:",e?e.error:"No response")}catch(e){console.error("Failed to save individual word:",t,e)}}if(t&&(t.textContent=`âœ… ${o.length} words saved individually!`,setTimeout(()=>{t.classList.remove("show")},3e3)),u(`${o.length} word${1!==o.length?"s":""} saved`),e.bubbleEl){const t=new Set(Array.from(e.selectedWords.entries()).map(([e])=>e));e.bubbleEl.querySelectorAll(".word-translation-item").forEach(e=>{const n=e.getAttribute("data-word");if(t.has(n)){const t=e.querySelector(".add-word-btn");t&&t.remove()}}),e.bubbleEl.querySelectorAll(".word-pill.selected").forEach(e=>e.classList.remove("selected"))}e.selectedWords.clear(),m()}catch(e){console.error("Failed to save vocabulary to IndexedDB:",e),t&&(t.textContent="âŒ Failed to save words. Please try again.",t.style.color="#dc2626",setTimeout(()=>{t.classList.remove("show"),t.style.color=""},5e3))}}()});const i=e.bubbleEl.querySelector(".combination-btn");i?.addEventListener("click",t=>{t.stopPropagation(),function(){e.combinationMode=!e.combinationMode,e.selectedWordsForCombination.clear();const t=e.bubbleEl?.querySelector(".combination-btn"),n=e.bubbleEl?.querySelector(".combination-status"),a=e.bubbleEl?.querySelectorAll(".word-pill");t&&n&&(e.combinationMode?(t.classList.add("active"),t.innerHTML="ðŸ”“",t.title="Exit combination mode",n.innerHTML='\n      <div class="combination-info">\n        <span>Select words for combined translation</span>\n      </div>\n    ',n.classList.add("show"),a.forEach(e=>{e.classList.remove("active","selected")}),e.selectedWords.clear(),m()):(t.classList.remove("active"),t.innerHTML="ðŸ”—",t.title="Enter combination mode for multiple words",n.innerHTML='\n      <div class="combination-info">\n        <span>Click words for individual translations</span>\n      </div>\n    ',a.forEach(e=>{e.classList.remove("combination-selected")}),y(),e.selectedWordsForCombination.clear()))}()})}}function v(){if(!e.pendingSelection)return;if(!e.extensionEnabled)return e.pendingSelection=null,void r();const{text:t,rect:n}=e.pendingSelection;r(),f(t,n),e.pendingSelection=null}async function w(t){if(!e.bubbleEl||!e.lastSelection)return;const n=e.bubbleEl.querySelector(".translated-text");n&&(n.textContent="Translating..."),e.tempTargetLang=t;const o=e.bubbleEl.querySelector(".word-translation");o&&(o.innerHTML="",o.classList.remove("show")),e.bubbleEl.querySelectorAll(".word-pill").forEach(e=>e.classList.remove("active","selected")),e.selectedWords.clear(),m();let s="auto";try{const e=await chrome.storage.sync.get(["sourceLanguage"]);e.sourceLanguage&&(s=e.sourceLanguage)}catch{}try{const a=await g(e.lastSelection,t,s);n&&(n.textContent=a)}catch(e){n&&(n.textContent="Translation failed: "+e.message)}const l=e.bubbleEl.querySelector(".language-badge.target-lang .lang-label");l&&(l.textContent=a(t))}async function h(n){try{if(!e.extensionEnabled)return;if(e.skipNextSelection)return void(e.skipNextSelection=!1);const a=window.getSelection();if(!a)return;if(e.bubbleEl&&n&&n.target&&e.bubbleEl.contains(n.target))return;const o=a.toString().trim();if(!o){const t=document.activeElement;if(e.bubbleEl&&t&&e.bubbleEl.contains(t)&&(t.classList.contains("translation-edit-input")||"INPUT"===t.tagName))return;return r(),void(e.pendingSelection=null)}let l;e.lastSelection=o;try{l=a.getRangeAt(0)}catch{return}const i=l.getClientRects();let c=l.getBoundingClientRect();c&&0===c.width&&i.length&&(c=i[0]);try{e.selectionContextElement=function(e){if(!e)return null;3===e.nodeType&&(e=e.parentElement);const t=new Set(["P","DIV","LI","ARTICLE","SECTION","MAIN","TD","TH"]);let n=e,a=0;for(;n&&n!==document.body&&a<10;){if(n.tagName&&t.has(n.tagName))return n;n=n.parentElement,a++}return n||null}(l.commonAncestorContainer)}catch{e.selectionContextElement=null}if(e.settings=await chrome.storage.sync.get(t),e.hotkeySpec=s(e.settings.bubbleHotkey),"auto"===e.settings.bubbleMode){if(e.bubbleEl)return;f(o,c)}else"icon"===e.settings.bubbleMode?(r(),e.pendingSelection={text:o,rect:c},function(){if(document.getElementById("__translator_trigger_icon_style"))return;const e=document.createElement("style");e.id="__translator_trigger_icon_style",e.textContent=".__translator_trigger_icon{background:#16a34a;color:#fff;font-size:14px;line-height:1;display:flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:50%;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);transition:transform .15s ease,background .2s;}.__translator_trigger_icon:hover{background:#15803d;transform:scale(1.05);}.__translator_trigger_icon:active{background:#166534;transform:scale(.95);} ",document.head.appendChild(e)}(),e.triggerIconTimer=setTimeout(()=>{e.pendingSelection&&e.pendingSelection.text===o&&function(t,n){if(!e.extensionEnabled)return;r();const a=document.createElement("div");a.className="__translator_trigger_icon",a.title="Translate selection",a.textContent="ðŸŒ";const o=window.pageXOffset||document.documentElement.scrollLeft,s=window.pageYOffset||document.documentElement.scrollTop;a.style.position="absolute",a.style.left=t.right+o-14+4+"px",a.style.top=t.bottom+s+6+"px",a.style.zIndex=999999,a.addEventListener("click",t=>{t.stopPropagation(),e.skipNextSelection=!0,r(),"function"==typeof n&&n()}),document.body.appendChild(a),e.triggerIconEl=a}(c,v)},Math.max(0,e.settings.bubbleIconDelay||0))):"hotkey"===e.settings.bubbleMode&&(r(),e.pendingSelection={text:o,rect:c})}catch(e){console.error("Translator content script selection handling error:",e)}}function _(e,t){return e.ctrl===t.ctrlKey&&e.shift===t.shiftKey&&e.alt===t.altKey&&e.meta===t.metaKey}chrome.storage.sync.get({extensionEnabled:!0},t=>{e.extensionEnabled=void 0===t.extensionEnabled||!!t.extensionEnabled}),document.addEventListener("keydown",t=>{if(e.settings&&"hotkey"===e.settings.bubbleMode){if(e.hotkeySpec){if(e.hotkeySpec.keys.length>1)return void(function(t,n){if(!t||t.keys.length<=1)return!1;const a=Date.now();(!_(t,n)||e.sequenceProgress>0&&a-e.lastSequenceTime>700)&&(e.sequenceProgress=0);const o=n.key.toLowerCase();return t.keys[e.sequenceProgress]===o?(e.sequenceProgress++,e.lastSequenceTime=a,e.sequenceProgress===t.keys.length&&(e.sequenceProgress=0,!0)):(t.keys[0]===o&&_(t,n)?(e.sequenceProgress=1,e.lastSequenceTime=a):e.sequenceProgress=0,!1)}(e.hotkeySpec,t)&&e.pendingSelection&&!e.bubbleEl&&v());if(function(e,t){return!(!e||1!==e.keys.length)&&_(e,t)&&e.keys[0]===t.key.toLowerCase()}(e.hotkeySpec,t))return void(e.pendingSelection&&!e.bubbleEl&&v())}if(!e.hotkeySpec&&"c"===t.key.toLowerCase()&&t.ctrlKey&&!t.shiftKey&&!t.altKey){const t=Date.now();t-e.lastCopyKeyTime<500&&e.pendingSelection&&!e.bubbleEl&&v(),e.lastCopyKeyTime=t}}}),document.addEventListener("mouseup",e=>{setTimeout(()=>h(e),10)}),document.addEventListener("keyup",e=>{setTimeout(()=>h(e),10)}),window.addEventListener("scroll",()=>{e.bubbleEl&&i(),e.pendingSelection&&r()},{passive:!0}),document.addEventListener("click",t=>{if(e.bubbleEl){const n=e.bubbleEl.contains(t.target),a=t.target.closest?.(".__translator_lang_menu");n||a||(i(),r(),e.pendingSelection=null)}},!0),chrome.storage.onChanged.addListener((n,a)=>{"sync"===a&&(n.extensionEnabled&&(e.extensionEnabled=!!n.extensionEnabled.newValue,e.extensionEnabled||(e.bubbleEl&&i(),r(),e.pendingSelection=null)),(n.bubbleMode||n.bubbleIconDelay||n.bubbleHotkey||n.target_lang)&&chrome.storage.sync.get(t,t=>{e.settings=t,e.hotkeySpec=s(e.settings.bubbleHotkey)}))}),(async()=>{})()})();